name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Type check
      run: npx tsc --noEmit

    - name: Build production
      run: npm run build
      env:
        # Mock env vars for build (CI doesn't need real keys)
        NEXT_PUBLIC_FIREBASE_API_KEY: ci-mock-key
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ci-mock.firebaseapp.com
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ci-mock-project
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ci-mock.appspot.com
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "123456789"
        NEXT_PUBLIC_FIREBASE_APP_ID: ci-mock-app-id
        NEXT_PUBLIC_APP_URL: http://localhost:3000
        FIREBASE_PROJECT_ID: ci-mock-project
        FIREBASE_CLIENT_EMAIL: ci-mock@ci-mock.iam.gserviceaccount.com
        FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7VJTUt9Us8cKj\nMzEfYyjiWA4R4/M2bS1+fWIcPm15j9tXBWjdULHsUnDpJVBz0hLRqz4sLiJv7Jqx\n-----END PRIVATE KEY-----\n"
        STRIPE_SECRET_KEY: sk_test_ci_mock_key
        STRIPE_WEBHOOK_SECRET: whsec_ci_mock_secret
        STRIPE_PRICE_ID_PRO: price_ci_mock_id

    - name: Check bundle size budget
      if: matrix.node-version == '20.x'
      run: |
        echo "Checking first-load JS bundle size..."
        BUNDLE_SIZE=$(du -sk .next/static/chunks | cut -f1)
        MAX_SIZE=307200  # 300 KB (in KB units)
        echo "Bundle size: ${BUNDLE_SIZE} KB"
        echo "Maximum allowed: ${MAX_SIZE} KB (300 KB)"
        if [ $BUNDLE_SIZE -gt $MAX_SIZE ]; then
          echo "❌ FAILED: Bundle size exceeds 300 KB limit"
          echo "Current: ${BUNDLE_SIZE} KB"
          echo "Limit: ${MAX_SIZE} KB"
          echo "Reduce bundle size by:"
          echo "  - Code splitting (dynamic imports)"
          echo "  - Removing unused dependencies"
          echo "  - Optimizing images and assets"
          exit 1
        fi
        echo "✅ PASSED: Bundle size within 300 KB limit"

    - name: Upload build artifacts
      if: matrix.node-version == '20.x'
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: .next/
        retention-days: 7

  accessibility:
    name: Accessibility Testing
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright browsers
      run: npx playwright install --with-deps chromium

    - name: Build application
      run: npm run build
      env:
        # Mock env vars for build
        NEXT_PUBLIC_FIREBASE_API_KEY: ci-mock-key
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ci-mock.firebaseapp.com
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ci-mock-project
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ci-mock.appspot.com
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "123456789"
        NEXT_PUBLIC_FIREBASE_APP_ID: ci-mock-app-id
        NEXT_PUBLIC_APP_URL: http://localhost:3000
        FIREBASE_PROJECT_ID: ci-mock-project
        FIREBASE_CLIENT_EMAIL: ci-mock@ci-mock.iam.gserviceaccount.com
        FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7VJTUt9Us8cKj\nMzEfYyjiWA4R4/M2bS1+fWIcPm15j9tXBWjdULHsUnDpJVBz0hLRqz4sLiJv7Jqx\n-----END PRIVATE KEY-----\n"
        STRIPE_SECRET_KEY: sk_test_ci_mock_key
        STRIPE_WEBHOOK_SECRET: whsec_ci_mock_secret
        STRIPE_PRICE_ID_PRO: price_ci_mock_id

    - name: Create accessibility test file
      run: |
        mkdir -p e2e
        cat > e2e/accessibility.spec.ts << 'EOL'
        import { test, expect } from '@playwright/test'
        import AxeBuilder from '@axe-core/playwright'

        test.describe('Accessibility Tests', () => {
          test('homepage accessibility', async ({ page }) => {
            await page.goto('http://localhost:3000')
            const results = await new AxeBuilder({ page }).analyze()

            expect(results.violations).toEqual([])

            if (results.violations.length > 0) {
              console.error('Accessibility violations found:')
              results.violations.forEach(violation => {
                console.error(`- ${violation.id}: ${violation.description}`)
                console.error(`  Impact: ${violation.impact}`)
                console.error(`  Affected elements: ${violation.nodes.length}`)
              })
            }
          })

          test('dashboard accessibility (unauthenticated)', async ({ page }) => {
            await page.goto('http://localhost:3000/dashboard')
            const results = await new AxeBuilder({ page }).analyze()

            expect(results.violations).toEqual([])
          })

          test('subscribe page accessibility', async ({ page }) => {
            await page.goto('http://localhost:3000/subscribe')
            const results = await new AxeBuilder({ page }).analyze()

            expect(results.violations).toEqual([])
          })
        })
        EOL

    - name: Install axe-core
      run: npm install --save-dev @axe-core/playwright

    - name: Start Next.js server
      run: npm start &
      env:
        NEXT_PUBLIC_FIREBASE_API_KEY: ci-mock-key
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ci-mock.firebaseapp.com
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ci-mock-project
        NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ci-mock.appspot.com
        NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: "123456789"
        NEXT_PUBLIC_FIREBASE_APP_ID: ci-mock-app-id
        NEXT_PUBLIC_APP_URL: http://localhost:3000
        FIREBASE_PROJECT_ID: ci-mock-project
        FIREBASE_CLIENT_EMAIL: ci-mock@ci-mock.iam.gserviceaccount.com
        FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7VJTUt9Us8cKj\nMzEfYyjiWA4R4/M2bS1+fWIcPm15j9tXBWjdULHsUnDpJVBz0hLRqz4sLiJv7Jqx\n-----END PRIVATE KEY-----\n"
        STRIPE_SECRET_KEY: sk_test_ci_mock_key
        STRIPE_WEBHOOK_SECRET: whsec_ci_mock_secret
        STRIPE_PRICE_ID_PRO: price_ci_mock_id

    - name: Wait for server
      run: npx wait-on http://localhost:3000 --timeout 60000

    - name: Run accessibility tests
      run: npx playwright test e2e/accessibility.spec.ts

    - name: Upload accessibility results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: accessibility-results
        path: playwright-report/
        retention-days: 7
